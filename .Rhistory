dir2 <- ifelse(nchar(x) == 9, "",
ifelse(nchar(x) == 10, paste0("/00",substr(x,10,10)),
ifelse(nchar(x) == 11, paste0("/0",substr(x,10,11)),
paste0("/",substr(x,10,12)))))
paste0(prefix,dir1,dir2,"/",x,"/",x,"_2.fastq.gz")
}
accession2urlR2("ERR3452699")
accession2urlR1("ERR3452574")
accession2urlR2("ERR3452574")
accession2urlR1("ERR3452529")
accession2urlR2("ERR3452529")
accession2urlR1("ERR3452318")
accession2urlR2("ERR3452318")
accession2urlR1("ERR3452699")
accession2urlR2("ERR3452699")
accession2urlR1("ERR3452574")
accession2urlR2("ERR3452574")
accession2urlR1("ERR3452529")
accession2urlR2("ERR3452529")
accession2urlR1("ERR3452318")
accession2urlR2("ERR3452318")
accession2urlR1("ERR3451635")
accession2urlR2("ERR3451635")
accession2urlR1("ERR2641799")
accession2urlR2("ERR2641799")
accession2urlR1("ERR2641792")
accession2urlR2("ERR2641792")
accession2urlR1("ERR2641793")
accession2urlR2("ERR2641793")
accession2urlR1("ERR2641795")
accession2urlR2("ERR2641795")
accession2urlR1("ERR2641798")
accession2urlR2("ERR2641798")
install.packages("neonUtilities")
install.packages("neonOS")
library(neonUtilities)
library(neonOS)
library(tidyverse)
soilChem <- loadByProduct(dpID = 'DP1.10086.001',
startdate = "2017-01",
enddate = "2019-12",
check.size = FALSE,
site = soilTrialSites,
package = 'expanded')
soilTrialSites = c("BONA","DEJU","HEAL","TOOL","BARR")
soilChem <- loadByProduct(dpID = 'DP1.10086.001',
startdate = "2017-01",
enddate = "2019-12",
check.size = FALSE,
site = soilTrialSites,
package = 'expanded')
packageVersion("data.table")
install.packages("data.table")
install.packages("data.table")
install.packages("data.table")
library(remotes)
install_version("data.table", version = "1.14.3", repos = "http://cran.us.r-project.org")
install_version("data.table", version = "1.14.4", repos = "http://cran.us.r-project.org")
install_version("data.table", version = "1.14.4", repos = "http://cran.us.r-project.org")
pkgbuild::check_build_tools(debug = TRUE)
install.packages("data.table")
x <- 1
rm(x)
library(neonUtilities)
library(neonOS)
library(tidyverse)
soilTrialSites = c("BONA","DEJU","HEAL","TOOL","BARR")
soilChem <- loadByProduct(dpID = 'DP1.10086.001',
startdate = "2017-01",
enddate = "2019-12",
check.size = FALSE,
site = soilTrialSites,
package = 'expanded')
View(soilChem$sls_soilChemistry)
View(soilChem$sls_metagenomicsPooling)
soilChem$sls_metagenomicsPooling$genomicsPooledIDList[11]
# you can check to confirm the first sample is TOOL_043-O-20170719-COMP
soilChem$sls_metagenomicsPooling[11,'genomicsSampleID']
View(soilChem$sls_soilChemistry %>%
filter(sampleID == "TOOL_043-O-5-7-20170719") %>%
select(sampleID,d15N,organicd13C,CNratio))
# split up the pooled list into new columns
genomicSamples <- soilChem$sls_metagenomicsPooling %>%
tidyr::separate(genomicsPooledIDList, into=c("first","second","third"),sep="\\|",fill="right") %>%
dplyr::select(genomicsSampleID,first,second,third)
# now view the table
View(genomicSamples)
genSampleExample <- genomicSamples %>%
tidyr::pivot_longer(cols=c("first","second","third"),values_to = "sampleID") %>%
dplyr::select(sampleID,genomicsSampleID) %>%
drop_na()
# now view
View(genSampleExample)
chemEx <- soilChem$sls_soilChemistry %>%
dplyr::select(sampleID,d15N,organicd13C,nitrogenPercent,organicCPercent)
## now combine the tables
combinedTab <- left_join(genSampleExample,chemEx, by = "sampleID") %>% drop_na()
View(combinedTab)
# Multiple samples composited to the genomic sample
# So, need to average
genome_groups <- combinedTab %>%
group_by(genomicsSampleID) %>%
summarize_at(c("d15N","organicd13C","nitrogenPercent","organicCPercent"), mean)
View(genome_groups)
# Be careful with pH
soilpH_Example <- soilChem$sls_soilpH %>%
dplyr::filter(sampleID %in% combinedTab$sampleID) %>%
dplyr::select(sampleID,soilInWaterpH,soilInCaClpH)
# have a look at this table
View(soilpH_Example)
# now join with the existing table
combinedTab_pH <- left_join(combinedTab,soilpH_Example, by = "sampleID")
# and the final
View(combinedTab_pH)
install.packages("respirometry")
library(respirometry)
genome_groups_pH <- combinedTab_pH %>%
group_by(genomicsSampleID) %>%
summarize_at(c("soilInWaterpH","soilInCaClpH"), mean_pH)
View(genome_groups_pH)
genome_groups_all <- combinedTab_pH %>%
group_by(genomicsSampleID) %>%
{left_join(
summarize_at(.,vars("d15N","organicd13C","nitrogenPercent","organicCPercent"), mean),
summarize_at(.,vars("soilInWaterpH","soilInCaClpH"), mean_pH)
)}
View(genome_groups_all)
#specify sites and/or date ranges depending on your research questions
metaGdata <- loadByProduct(dpID = 'DP1.10107.001',
startdate = "2018-01",
enddate = "2019-12",
check.size = FALSE,
package = 'expanded')
rawFileInfo <- metaGdata$mms_rawDataFiles
View(rawFileInfo)
urls_fordownload <- unique(rawFileInfo$rawDataFilePath)
urls_fordownload
# Subsetting
# Option a, create a list of samples from earlier example
targetsamples <- combinedTab$genomicsSampleID
# Create a genomicsSampleID from raw files table, and then subset this to samples
rawfiles_ids <- rawFileInfo %>%
mutate(genomicsSampleID = gsub("-DNA[1,2,3]","",dnaSampleID)) %>%
subset(genomicsSampleID %in% targetsamples) %>%
unique()
urls_fordownload <- unique(rawfiles_ids$rawDataFilePath)
# Option b
urls_fordownload <- unique(rawFileInfo$rawDataFilePath)[1:20] #for instance, the first 20 rows, and so on
#### 3. Real ####
metaGdata <- loadByProduct(dpID = 'DP1.10107.001',
startdate = "2023-01",
enddate = "2023-12",
check.size = FALSE,
package = 'expanded')
#### 3. Real ####
metaGdata <- loadByProduct(dpID = 'DP1.10107.001',
startdate = "2022-01",
enddate = "2022-12",
check.size = FALSE,
package = 'expanded')
View(metaGdata)
rawFileInfo <- metaGdata$mms_rawDataFiles
View(rawFileInfo)
#### 3. Real ####
soilChem <- loadByProduct(dpID = 'DP1.10086.001',
startdate = "2023-01",
enddate = "2023-12",
check.size = FALSE,
site = soilTrialSites,
package = 'expanded')
View(soilChem$sls_soilChemistry)
library(devtools)
install.packages("devtools")
library(devtools)
install_github("NEONScience/phyloNEON/phyloNEON")
install_github("NEONScience/phyloNEON/phyloNEON")
library(remotes)
install_github("NEONScience/phyloNEON/phyloNEON")
install_github("NEONScience/phyloNEON")
install_github("NEONScience/phyloNEON/")
#### 1. Setup ####
library(neonUtilities)
library(neonOS)
library(tidyverse)
library(respirometry)
library(devtools)
devtools::install_github("NEONScience/phyloNEON")
Sys.unsetenv("GITHUB_PAT")
devtools::install_github("NEONScience/phyloNEON")
Sys.unsetenv("GITHUB_PAT")
devtools::install_github("NEONScience/phyloNEON")
Sys.setenv(GITHUB_PAT = "")
devtools::install_github("NEONScience/phyloNEON")
remotes::install_github(
"NEONScience/phyloNEON",
auth_token = NULL,
upgrade = "never"
)
remotes::install_github(
"NEONScience/phyloNEON",
auth_token = NULL,
upgrade = "never"
)
#### 1. Setup ####
library(neonUtilities)
library(neonOS)
library(tidyverse)
library(respirometry)
library(devtools)
library(remotes)
Sys.setenv(GITHUB_PAT = "")
remotes::install_github(
"NEONScience/phyloNEON",
auth_token = NULL,
upgrade = "never"
)
remotes::install_github(
"NEONScience/phyloNEON/phyloNEON",
auth_token = NULL,
upgrade = "never"
)
library(phyloNEON)
View(neon.metaDB)
metaDB <- data("neon.metaDB")
View(neon.metaDB)
jgi <- metaDB %>%
filter(`Sequencing Center` == "DOE Joint Genome Institute  (JGI)")
jgi <- metaDB %>%
dplyr::filter(`Sequencing Center` == "DOE Joint Genome Institute  (JGI)")
jgi <- metaDB %>%
filter("Sequencing Center" == "DOE Joint Genome Institute  (JGI)")
rm(metaDB)
jgi <- neon.metaDB %>%
filter("Sequencing Center" == "DOE Joint Genome Institute  (JGI)")
View(neon.metaDB)
jgi <- neon.metaDB %>%
filter(`Sequencing Center` == "DOE Joint Genome Institute  (JGI)")
table(jgi$collectDate)
jgi$collectDate
jgi <- neon.metaDB %>%
filter(`Sequencing Center` == "DOE Joint Genome Institute  (JGI)") %>%
mutate(Year = substr(collectDate, start = 1, stop = 5))
table(jgi$Year)
jgi <- neon.metaDB %>%
filter(`Sequencing Center` == "DOE Joint Genome Institute  (JGI)") %>%
mutate(Year = substr(collectDate, start = 1, stop = 4))
table(jgi$Year)
jgi <- neon.metaDB %>%
filter(`Sequencing Center` == "DOE Joint Genome Institute  (JGI)") %>%
mutate(Year = substr(collectDate, start = 1, stop = 4)) %>%
filter(Year == 2023)
table(jgi$Ecosystem)
table(jgi$`Ecosystem Category`)
table(jgi$`Ecosystem Subtype`)
table(jgi$`Ecosystem Type`)
table(jgi$`Specific Ecosystem`)
table(jgi$jgiProjectID)
table(jgi$`ITS Proposal ID`)
table(jgi$`Sequencing Status`)
table(jgi$`Study Name`)
table(jgi$`Funding Program`)
table(jgi$`Sequencing Method`)
table(jgi$siteID)
jgi <- neon.metaDB %>%
filter(`Sequencing Center` == "DOE Joint Genome Institute  (JGI)") %>%
mutate(Year = substr(collectDate, start = 1, stop = 4)) %>%
filter(Year == 2023) %>%
filter(`Ecosystem Category` == "Terrestrial")
table(jgi$Ecosystem)
table(jgi$`Ecosystem Category`) # 303 terrestrial (222 aquatic)
table(jgi$`Ecosystem Type`)
table(jgi$`Ecosystem Subtype`)
table(jgi$`Specific Ecosystem`)
table(jgi$`ITS Proposal ID`) # 509938 - use this on JGI portal?
table(jgi$`Sequencing Status`)
table(jgi$`Study Name`) # Soil and water microbial communities from various NEON Field Sites across the United States
table(jgi$`Funding Program`)
table(jgi$`Sequencing Method`)
table(jgi$siteID)
length(table(jgi$siteID))
hist(jgi$GenomeSize)
View(jgi)
hist(jgi$numberFilteredReads)
rane(jgi$numberFilteredReads)
range(jgi$numberFilteredReads)
library(gdm)
citation("gdm")
library(plyr)
library(tidyverse)
library(readxl)
library(writexl)
library(mctoolsr)
library(vegan)
library(microseq)
library(FSA)
library(car)
library(RColorBrewer)
library(scales)
library(ggrepel)
library(cowplot)
library(ggh4x)
library(pheatmap)
library(ANCOMBC)
library(phyloseq)
library(DESeq2)
library(KEGGREST)
library(corrplot)
library(VennDiagram)
library(ggvenn)
library(corrplot)
# Working directory
setwd("~/Documents/GitHub/AndesAg/")
# Functions
`%notin%` <- Negate(`%in%`)
find_hull <- function(df) df[chull(df$Axis01, df$Axis02),]
# cliffplot
source("code/cliffplot_taxa_bars.R")
# Effect size (from Jack Darcy, Science Advances 2018)
source("code/effectSize.R")
#### __Prok ####
input_filt_rare <- readRDS("data/input_filt_rare_mtagsProk_all.rds")
input_filt_rare$map_loaded <- input_filt_rare$map_loaded %>%
mutate(Treatment = factor(Treatment,
levels = c("Control",
"+Basalt",
"+MP1",
"+MP1+Basalt"))) %>%
mutate(Treatment = case_match(Treatment,
"Control" ~ "UTC",
"+Basalt" ~ "B",
"+MP1" ~ "MP1",
"+MP1+Basalt" ~ "MP1+B")) %>%
mutate(Treatment = factor(Treatment,
levels = c("UTC", "MP1", "B", "MP1+B"))) %>%
# mutate(Treatment = case_match(Treatment,
#                               "Control" ~ "UTC",
#                               "+Basalt" ~ "UTC+B",
#                               "+MP1" ~ "MP1",
#                               "+MP1+Basalt" ~ "MP1+B")) %>%
# mutate(Treatment = factor(Treatment,
#                           levels = c("UTC", "MP1", "UTC+B", "MP1+B"))) %>%
mutate(Depth = as.factor(Depth)) %>%
mutate(TrtDep = factor(paste(Treatment, Depth, sep = "_"),
levels = c("Control_10", "Control_20", "Control_30",
"+Basalt_10", "+Basalt_20", "+Basalt_30",
"+MP1_10", "+MP1_20", "+MP1_30",
"+MP1+Basalt_10", "+MP1+Basalt_20",
"+MP1+Basalt_30")))
# Got soil data later, import and merge that
# Note: Alk data is just 1 per column so repeated values
soil <- read.csv("data/andes_cs5_compiled_soil_data.csv") %>%
mutate(Comb = paste(Treatment, Condition, sep = "_")) %>%
mutate(Group = ifelse(Comb == "MP1_Basalt", "C",
ifelse(Comb == "MP1_NB", "A",
ifelse(Comb == "UTC_Basalt", "B", "D")))) %>%
mutate(Comb = gsub("MP1_Basalt", "+MP1+Basalt", Comb)) %>%
mutate(Comb = gsub("MP1_NB", "+MP1", Comb)) %>%
mutate(Comb = gsub("UTC_Basalt", "+Basalt", Comb)) %>%
mutate(Comb = gsub("UTC_NB", "Control", Comb)) %>%
mutate(Treatment = factor(Comb,
levels = c("Control",
"+Basalt",
"+MP1",
"+MP1+Basalt"))) %>%
mutate(Treatment = case_match(Treatment,
"Control" ~ "UTC",
"+Basalt" ~ "B",
"+MP1" ~ "MP1",
"+MP1+Basalt" ~ "MP1+B")) %>%
mutate(Treatment = factor(Treatment,
levels = c("UTC", "MP1", "B", "MP1+B"))) %>%
# mutate(Treatment = case_match(Treatment,
#                               "Control" ~ "UTC",
#                               "+Basalt" ~ "UTC+B",
#                               "+MP1" ~ "MP1",
#                               "+MP1+Basalt" ~ "MP1+B")) %>%
# mutate(Treatment = factor(Treatment,
#                           levels = c("UTC", "MP1", "UTC+B", "MP1+B"))) %>%
mutate(sampleID = paste(Group, Column, Increment, sep = ".")) %>%
dplyr::select(-Treatment, -Condition, -Increment, -Column, -Comb, -Group) %>%
dplyr::select(sampleID, everything())
dim(input_filt_rare$map_loaded)
rownames(input_filt_rare$map_loaded)
input_filt_rare$map_loaded <- input_filt_rare$map_loaded %>%
left_join(., soil, by = "sampleID")
dim(input_filt_rare$map_loaded)
rownames(input_filt_rare$map_loaded) <- input_filt_rare$map_loaded$sampleID
# Check soil correlations
soil <- input_filt_rare$map_loaded %>%
dplyr::select(17:37)
m <- cor(soil)
corrplot(m,
method = "square",
type = "lower",
diag = FALSE,
hclust.method = "ward.D2",
tl.cex = 0.5)
# PCA of soil
pca <- rda(soil, scale = TRUE)  # `scale=TRUE` standardizes variables
summary(pca)
#### ___10 ####
# Rerun alpha and beta just on 10 cm samples
top <- filter_data(input_filt_rare,
filter_cat = "Depth",
keep_vals = 10) # 24 samples remaining
bac <- filter_taxa_from_input(top,
at_spec_level = 6,
taxa_to_keep = "Bacillus")
#### Phylum level
tax_sum_phy <- summarize_taxonomy(input = top,
level = 2,
relative = T,
report_higher_tax = F)
cliffplot_taxa_bars(top, 2, "Treatment")
top_phy <- tax_sum_phy %>%
mutate(MeanAbund = rowMeans(.)) %>%
rownames_to_column(var = "Phylum") %>%
dplyr::select(Phylum, MeanAbund) %>%
arrange(desc(MeanAbund))
# Make nice graph of top 12 phyla
bars_phyla <- plot_taxa_bars(tax_table = tax_sum_phy,
metadata_map = input_filt_rare$map_loaded,
type_header = "sampleID",
num_taxa = 13,
data_only = T) %>%
left_join(., input_filt_rare$map_loaded, by = c("group_by" = "sampleID"))
top_phyla <- bars_phyla %>%
group_by(taxon) %>%
summarise(mean = mean(mean_value)) %>%
filter(taxon != "Other") %>%
filter(taxon != "NA") %>%
arrange(-mean) %>%
mutate(taxon = as.character(taxon))
bars_phyla <- bars_phyla %>%
mutate(taxon = factor(taxon,
levels = c("Other", rev(top_phyla$taxon))))
phyplot <- ggplot(bars_phyla, aes(group_by, mean_value, fill = taxon)) +
geom_bar(stat = "identity", colour = NA, linewidth = 0.25) +
labs(x = "Sample", y = "Relative abundance", fill = "Phylum") +
scale_fill_manual(values = c("grey75", "grey90", brewer.pal(12, "Paired")[12:1])) +
scale_y_continuous(expand = c(0.01, 0.01)) +
facet_grid(~ Treatment, space = "free", scales = "free_x") +
theme_classic() +
theme(axis.title.y = element_text(face = "bold", size = 12),
axis.title.x = element_blank(),
axis.text.y = element_text(size = 10),
axis.text.x = element_blank(),
axis.ticks.x = element_blank(),
axis.line.x = element_blank(),
axis.line.y = element_blank(),
strip.text = element_text(size = 7),
strip.background = element_rect(linewidth = 0.5),
legend.position = "right",
legend.margin = margin(0, 0, 0, 0, unit = "pt"),
legend.box.margin = margin(0, 0, 0, 0, unit = "pt"),
legend.key.size = unit(0.4, "cm"),
panel.spacing.x = unit(c(0.2, 0.2, 0.2), "lines"))
phyplot
View(bars_phyla)
# Make another one just with UTC and MP1
bars_phyla_sub <- bars_phyla %>%
filter(Treatment %in% c("UTC", "MP1"))
phyplot <- ggplot(bars_phyla_sub, aes(group_by, mean_value, fill = taxon)) +
geom_bar(stat = "identity", colour = NA, linewidth = 0.25) +
labs(x = "Sample", y = "Relative abundance", fill = "Phylum") +
scale_fill_manual(values = c("grey75", "grey90", brewer.pal(12, "Paired")[12:1])) +
scale_y_continuous(expand = c(0.01, 0.01)) +
facet_grid(~ Treatment, space = "free", scales = "free_x") +
theme_classic() +
theme(axis.title.y = element_text(face = "bold", size = 12),
axis.title.x = element_blank(),
axis.text.y = element_text(size = 10),
axis.text.x = element_blank(),
axis.ticks.x = element_blank(),
axis.line.x = element_blank(),
axis.line.y = element_blank(),
strip.text = element_text(size = 7),
strip.background = element_rect(linewidth = 0.5),
legend.position = "right",
legend.margin = margin(0, 0, 0, 0, unit = "pt"),
legend.box.margin = margin(0, 0, 0, 0, unit = "pt"),
legend.key.size = unit(0.4, "cm"),
panel.spacing.x = unit(c(0.2, 0.2, 0.2), "lines"))
phyplot
phyplot <- ggplot(bars_phyla_sub, aes(group_by, mean_value, fill = taxon)) +
geom_bar(stat = "identity", colour = NA, linewidth = 0.25) +
labs(x = "Sample", y = "Relative abundance", fill = "Phylum") +
scale_fill_manual(values = c("grey75", "grey90", brewer.pal(12, "Paired")[12:1])) +
scale_y_continuous(expand = c(0.01, 0.01)) +
facet_grid(~ Treatment, space = "free", scales = "free_x") +
theme_classic() +
theme(axis.title.y = element_text(face = "bold", size = 12),
axis.title.x = element_blank(),
axis.text.y = element_text(size = 10),
axis.text.x = element_blank(),
axis.ticks.x = element_blank(),
axis.line.x = element_blank(),
axis.line.y = element_blank(),
strip.text = element_text(size = 7),
strip.background = element_rect(linewidth = 0.5),
legend.position = "right",
legend.margin = margin(0, 0, 0, 0, unit = "pt"),
legend.box.margin = margin(0, 0, 0, 0, unit = "pt"),
legend.key.size = unit(0.4, "cm"),
panel.spacing.x = unit(c(0.2), "lines"))
phyplot
pdf("InitialFigs/Phylum_Barplot_UTC_MP1_10cm.pdf", width = 8, height = 6)
phyplot
dev.off()
png("InitialFigs/Phylum_Barplot_UTC_MP1_10cm.png", width = 8, height = 6, units = "in", res = 300)
phyplot
dev.off()
